<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Map Builder 🌳 (Drag & Drop)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Baloo 2', cursive;
            background-color: #f0fdf4; /* A light, friendly green */
            overflow: hidden;
        }
        #background-vectors {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
        }
        .main-topic {
            background: #22c55e; /* Green-500 */
            color: white;
            border: 4px solid #166534; /* Green-800 */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .idea-card {
            cursor: grab;
            transition: all 0.2s ease-in-out;
            border: 2px solid #a7f3d0; /* Green-200 */
        }
        .idea-card:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -2px rgba(0,0,0,0.1);
        }
        .drop-zone {
            border: 3px dashed #4ade80; /* Green-400 */
            transition: all 0.2s ease-in-out;
            min-height: 80px;
            width: 160px;
        }
        .drop-zone.drag-over {
            background-color: #dcfce7; /* Green-100 */
            border-style: solid;
        }
        .placed-card {
            cursor: not-allowed;
            background-color: #fef9c3; /* Yellow-100 */
            border-color: #facc15; /* Yellow-400 */
            animation: pop 0.3s ease-out;
        }
        .placed-subtopic {
            background-color: #86efac; /* Green-300 */
            border-color: #22c55e; /* Green-500 */
            font-weight: bold;
            animation: pop 0.3s ease-out;
        }
        .shake { animation: shake 0.5s; }
        .combo-text { animation: combo-pop 0.5s ease-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes pop {
            0% { transform: scale(0.8); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes combo-pop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .branch-line {
            position: absolute;
            background-color: #a3a3a3; /* Neutral-400 */
            transform-origin: left center;
            z-index: 0;
        }
        .lang-btn {
            transition: all 0.2s ease-in-out;
        }
        .lang-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.15);
        }
        .star {
            font-size: 3rem;
            color: #d1d5db; /* Gray-300 */
            transition: color 0.3s ease-in-out;
        }
        .star.filled {
            color: #f59e0b; /* Amber-500 */
        }
    </style>
</head>
<body class="text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="background-vectors">
        <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <path d="M-100,50 Q50,150 200,50 T450,50" stroke="#a7f3d0" fill="none" stroke-width="4" />
            <path d="M-50,250 Q100,350 300,250 T550,250" stroke="#a7f3d0" fill="none" stroke-width="4" />
            <path d="M80vw, -50 Q90vw, 50vh 80vw, 110vh" stroke="#a7f3d0" fill="none" stroke-width="4" />
        </svg>
    </div>

    <!-- Language Selection Screen -->
    <div id="language-selection-screen" class="text-center relative z-10">
        <h1 class="text-5xl font-bold text-green-700 mb-4">Mind Map Builder 🌳</h1>
        <p class="text-2xl text-gray-600 mb-8">Please Select a Language</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button data-lang="en" class="lang-btn bg-green-500 text-white font-bold py-4 px-8 rounded-xl text-2xl">English</button>
            <button data-lang="tr" class="lang-btn bg-red-500 text-white font-bold py-4 px-8 rounded-xl text-2xl">Türkçe</button>
            <button data-lang="zh" class="lang-btn bg-yellow-500 text-white font-bold py-4 px-8 rounded-xl text-2xl">中文</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="w-full max-w-7xl mx-auto hidden relative z-10">
        
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 id="game-title" class="text-4xl md:text-5xl font-bold text-green-700">Mind Map Builder 🌳</h1>
            <div class="mt-2 flex justify-center items-center flex-wrap gap-x-6 gap-y-2 text-xl">
                <div><strong id="level-label">Level</strong>: <span id="level-indicator">1</span></div>
                <div><strong id="time-label">Time</strong>: <span id="timer">120</span>s</div>
                <div><strong id="score-label">Score</strong>: <span id="score">0</span></div>
                <div class="relative"><strong id="combo-label">Combo</strong>: <span id="combo-counter">0</span><span id="combo-bonus-text" class="absolute left-1/2 -top-4 text-green-500 font-bold"></span></div>
            </div>
        </header>

        <!-- Main Game Area -->
        <main class="flex flex-col md:flex-row gap-4">
            <aside class="w-full md:w-1/4 bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg border-2 border-gray-200 flex flex-col gap-4">
                <div><h2 id="main-ideas-label" class="text-2xl font-bold text-center mb-2 text-green-600">Main Ideas</h2><div id="main-ideas-bank" class="space-y-2 bg-green-50 p-2 rounded-lg min-h-[100px]"></div></div><hr/>
                <div><h2 id="details-label" class="text-2xl font-bold text-center mb-2 text-yellow-600">Details</h2><div id="details-bank" class="space-y-2 bg-yellow-50 p-2 rounded-lg min-h-[200px]"></div></div>
            </aside>
            <div class="w-full md:w-3/4 bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-lg border-2 border-gray-200 relative overflow-hidden">
                <div id="mind-map" class="relative flex items-center justify-center h-full min-h-[500px] md:min-h-[600px]">
                    <div id="main-topic" class="main-topic rounded-full w-48 h-48 flex items-center justify-center text-center text-2xl font-bold p-4 z-10 relative"></div>
                    <div class="absolute top-0 left-0 w-full h-full z-0" id="branches-container"></div>
                </div>
            </div>
        </main>

        <!-- Game Over Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-2xl shadow-2xl text-center transform transition-all scale-95 opacity-0">
                <div id="star-rating" class="flex justify-center mb-4">
                    <span class="star">★</span><span class="star">★</span><span class="star">★</span>
                </div>
                <h2 id="modal-title" class="text-4xl font-bold text-green-600 mb-2"></h2>
                <p id="modal-subtitle" class="text-xl mb-4"></p>
                <div class="text-2xl font-bold mb-6"><span id="final-score-label">Final Score</span>: <span id="final-score">0</span></div>
                <button id="next-level-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105"></button>
            </div>
        </div>
    </div>

    <script>
        // --- TRANSLATIONS with Emojis ---
        const translations = {
            'en': {
                ui: { title: "Mind Map Builder 🌳", level: "Level", time: "Time", score: "Score", combo: "Combo", mainIdeas: "Main Ideas", details: "Details", levelComplete: "Level Complete! 🎉", masterMapper: "You're a master mind-mapper!", timesUp: "Time's Up! ⏰", finalScore: "Final Score", nextLevel: "Next Level", playAgain: "Play Again", tryAgain: "Try Again", gameFinished: "You finished the game! 🏆" },
                levels: [
                    { mainTopic: "🏛️ Ancient Rome", subtopics: [{ id: 'sub-gov', text: '🏛️ Government', details: ['Senate', 'Republic'] }, { id: 'sub-arch', text: '🏗️ Architecture', details: ['Colosseum', 'Aqueducts'] }, { id: 'sub-people', text: '👨‍⚖️ Famous People', details: ['Julius Caesar', 'Augustus'] }] },
                    { mainTopic: "🪐 The Solar System", subtopics: [{ id: 'sub-inner', text: '🔥 Inner Planets', details: ['Mercury', 'Venus', 'Earth', 'Mars'] }, { id: 'sub-outer', text: '🧊 Outer Planets', details: ['Jupiter', 'Saturn', 'Uranus', 'Neptune'] }, { id: 'sub-other', text: '☄️ Other Objects', details: ['Asteroid Belt', 'Comets'] }] },
                    { mainTopic: "💧 The Water Cycle", subtopics: [{ id: 'sub-evap', text: '☀️ Evaporation', details: ['Sun heats water', 'Turns to vapor'] }, { id: 'sub-cond', text: '☁️ Condensation', details: ['Vapor cools', 'Forms clouds'] }, { id: 'sub-precip', text: '🌧️ Precipitation', details: ['Rain, snow, sleet', 'Water falls to Earth'] }] },
                    { mainTopic: "🌱 Parts of a Plant", subtopics: [{ id: 'sub-roots', text: '👇 Roots', details: ['Absorb water', 'Anchor plant'] }, { id: 'sub-stem', text: '🌴 Stem', details: ['Supports leaves', 'Carries water'] }, { id: 'sub-leaves', text: '🍃 Leaves', details: ['Photosynthesis', 'Makes food'] }] },
                    { mainTopic: "🏺 Ancient Egypt", subtopics: [{ id: 'sub-geo', text: '🗺️ Geography', details: ['Nile River', 'Sahara Desert'] }, { id: 'sub-culture', text: '📜 Culture', details: ['Hieroglyphs', 'Pyramids'] }, { id: 'sub-pharaohs', text: '👑 Pharaohs', details: ['Tutankhamun', 'Cleopatra'] }] },
                    { mainTopic: "📚 Literary Genres", subtopics: [{ id: 'sub-fic', text: '🦄 Fiction', details: ['Fantasy', 'Sci-Fi'] }, { id: 'sub-nonfic', text: '🧐 Non-Fiction', details: ['Biography', 'History'] }, { id: 'sub-poetry', text: '✍️ Poetry', details: ['Haiku', 'Sonnet'] }] },
                    { mainTopic: "🗳️ Types of Government", subtopics: [{ id: 'sub-dem', text: '🙋 Democracy', details: ['Rule by the people', 'Elections'] }, { id: 'sub-mon', text: '👑 Monarchy', details: ['King or Queen', 'Hereditary rule'] }, { id: 'sub-dict', text: '🎖️ Dictatorship', details: ['One ruler', 'No elections'] }] },
                    { mainTopic: "🌍 Continents & Oceans", subtopics: [{ id: 'sub-cont', text: '🌎 Continents', details: ['Asia', 'Africa', 'North America'] }, { id: 'sub-oceans', text: '🌊 Oceans', details: ['Pacific', 'Atlantic', 'Indian'] }] },
                    { mainTopic: "🍎 Food Groups", subtopics: [{ id: 'sub-fruit', text: '🥦 Fruits & Veggies', details: ['Apples', 'Broccoli'] }, { id: 'sub-prot', text: '🍗 Proteins', details: ['Chicken', 'Beans'] }, { id: 'sub-grain', text: '🍞 Grains', details: ['Bread', 'Rice'] }] },
                    { mainTopic: "📝 Note-Taking Methods", subtopics: [{ id: 'sub-mindmap', text: '🌳 Mind Maps', details: ['Visual', 'Branches'] }, { id: 'sub-bullet', text: '➡️ Bullet Points', details: ['Lists', 'Short phrases'] }, { id: 'sub-cornell', text: '📖 Cornell Method', details: ['Cues', 'Summary'] }] }
                ]
            },
            'tr': {
                ui: { title: "Zihin Haritası Oluşturucu 🌳", level: "Seviye", time: "Süre", score: "Puan", combo: "Kombo", mainIdeas: "Ana Fikirler", details: "Detaylar", levelComplete: "Seviye Tamamlandı! 🎉", masterMapper: "Harika bir zihin haritacısısın!", timesUp: "Süre Doldu! ⏰", finalScore: "Son Puan", nextLevel: "Sonraki Seviye", playAgain: "Tekrar Oyna", tryAgain: "Tekrar Dene", gameFinished: "Oyunu bitirdin! 🏆" },
                levels: [
                    { mainTopic: "🏛️ Antik Roma", subtopics: [{ id: 'sub-gov', text: '🏛️ Yönetim', details: ['Senato', 'Cumhuriyet'] }, { id: 'sub-arch', text: '🏗️ Mimari', details: ['Kolezyum', 'Su kemerleri'] }, { id: 'sub-people', text: '👨‍⚖️ Ünlü Kişiler', details: ['Jül Sezar', 'Augustus'] }] },
                    { mainTopic: "🪐 Güneş Sistemi", subtopics: [{ id: 'sub-inner', text: '🔥 İç Gezegenler', details: ['Merkür', 'Venüs', 'Dünya', 'Mars'] }, { id: 'sub-outer', text: '🧊 Dış Gezegenler', details: ['Jüpiter', 'Satürn', 'Uranüs', 'Neptün'] }, { id: 'sub-other', text: '☄️ Diğer Nesneler', details: ['Asteroit Kuşağı', 'Kuyruklu Yıldızlar'] }] },
                    { mainTopic: "💧 Su Döngüsü", subtopics: [{ id: 'sub-evap', text: '☀️ Buharlaşma', details: ['Güneş suyu ısıtır', 'Buğdaya dönüşür'] }, { id: 'sub-cond', text: '☁️ Yoğunlaşma', details: ['Buhar soğur', 'Bulutları oluşturur'] }, { id: 'sub-precip', text: '🌧️ Yağış', details: ['Yağmur, kar, dolu', 'Su yeryüzüne düşer'] }] },
                ]
            },
            'zh': {
                ui: { title: "思维导图构建器 🌳", level: "等级", time: "时间", score: "分数", combo: "连击", mainIdeas: "主要思想", details: "细节", levelComplete: "完成本级！ 🎉", masterMapper: "你是一位思维导图大师！", timesUp: "时间到！ ⏰", finalScore: "最终得分", nextLevel: "下一级", playAgain: "再玩一次", tryAgain: "再试一次", gameFinished: "你完成了游戏！ 🏆" },
                levels: [
                    { mainTopic: "🏛️ 古罗马", subtopics: [{ id: 'sub-gov', text: '🏛️ 政府', details: ['元老院', '共和国'] }, { id: 'sub-arch', text: '🏗️ 建筑', details: ['罗马斗兽场', '水道'] }, { id: 'sub-people', text: '👨‍⚖️ 名人', details: ['尤利乌斯·凯撒', '奥古斯都'] }] },
                    { mainTopic: "🪐 太阳系", subtopics: [{ id: 'sub-inner', text: '🔥 内行星', details: ['水星', '金星', '地球', '火星'] }, { id: 'sub-outer', text: '🧊 外行星', details: ['木星', '土星', '天王星', '海王星'] }, { id: 'sub-other', text: '☄️ 其他天体', details: ['小行星带', '彗星'] }] },
                    { mainTopic: "💧 水循环", subtopics: [{ id: 'sub-evap', text: '☀️ 蒸发', details: ['太阳加热水', '变成蒸汽'] }, { id: 'sub-cond', text: '☁️ 凝结', details: ['蒸汽冷却', '形成云'] }, { id: 'sub-precip', text: '🌧️ 降水', details: ['雨、雪、冰雹', '水落到地面'] }] },
                ]
            }
        };
        if (!translations.tr.levels[3]) translations.tr.levels = translations.en.levels.map(l => ({...l})); // Fallback for missing translations
        if (!translations.zh.levels[3]) translations.zh.levels = translations.en.levels.map(l => ({...l})); // Fallback for missing translations


        // DOM Elements
        const langScreenEl = document.getElementById('language-selection-screen');
        const gameContainerEl = document.getElementById('game-container');
        const langButtons = document.querySelectorAll('[data-lang]');
        const levelIndicatorEl = document.getElementById('level-indicator');
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const comboCounterEl = document.getElementById('combo-counter');
        const comboBonusTextEl = document.getElementById('combo-bonus-text');
        const mainIdeasBankEl = document.getElementById('main-ideas-bank');
        const detailsBankEl = document.getElementById('details-bank');
        const mainTopicEl = document.getElementById('main-topic');
        const branchesContainerEl = document.getElementById('branches-container');
        const mindMapEl = document.getElementById('mind-map');
        const modalEl = document.getElementById('modal');
        const starRatingEl = document.getElementById('star-rating');
        const modalTitleEl = document.getElementById('modal-title');
        const finalScoreEl = document.getElementById('final-score');
        const nextLevelBtn = document.getElementById('next-level-btn');

        // Game State
        let selectedLanguage = 'en';
        let currentLevel = 0;
        let score = 0;
        let timeLeft = 120;
        let timerInterval;
        let totalCards = 0;
        let placedCards = 0;
        let comboCounter = 0;
        let maxScorePossible = 0;

        // --- SOUND ENGINE ---
        let audioCtx;
        function playSound(type) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);

            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            } else { // 'wrong'
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(164.81, audioCtx.currentTime); // E3
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3);
            }
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        function translateUI() {
            const ui = translations[selectedLanguage].ui;
            document.getElementById('game-title').textContent = ui.title;
            document.getElementById('level-label').textContent = ui.level;
            document.getElementById('time-label').textContent = ui.time;
            document.getElementById('score-label').textContent = ui.score;
            document.getElementById('combo-label').textContent = ui.combo;
            document.getElementById('main-ideas-label').textContent = ui.mainIdeas;
            document.getElementById('details-label').textContent = ui.details;
            document.getElementById('final-score-label').textContent = ui.finalScore;
            document.getElementById('modal-subtitle').textContent = ui.masterMapper;
        }

        function startGame(lang) {
            selectedLanguage = lang;
            langScreenEl.classList.add('hidden');
            gameContainerEl.classList.remove('hidden');
            translateUI();
            setTimeout(() => setupLevel(currentLevel), 100);
        }

        langButtons.forEach(button => {
            button.addEventListener('click', () => {
                 if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); // Init on user interaction
                startGame(button.dataset.lang);
            });
        });

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; }
            return array;
        }

        function createCard(id, text, type, parentId = null) {
            const card = document.createElement('div');
            card.id = id; card.innerHTML = text; card.draggable = true; card.dataset.type = type;
            if (parentId) card.dataset.parentId = parentId;
            card.className = 'idea-card p-3 rounded-lg shadow-sm text-center text-lg';
            if(type === 'subtopic') card.classList.add('bg-green-100'); else card.classList.add('bg-yellow-50');
            card.addEventListener('dragstart', onDragStart);
            return card;
        }
        
        function createDropZone(id, type, parentId = null) {
            const wrapper = document.createElement('div'); const dropZone = document.createElement('div');
            dropZone.id = `drop-${id}`; dropZone.dataset.targetId = id; dropZone.dataset.type = type;
            if (parentId) dropZone.dataset.parentId = parentId;
            dropZone.className = 'drop-zone p-2 rounded-lg space-y-2';
            wrapper.appendChild(dropZone);
            dropZone.addEventListener('dragover', onDragOver); dropZone.addEventListener('dragleave', onDragLeave); dropZone.addEventListener('drop', onDrop);
            return wrapper;
        }

        function setupLevel(levelIndex) {
            const levelData = translations[selectedLanguage].levels[levelIndex];
            score = 0; timeLeft = 120; placedCards = 0; comboCounter = 0;
            updateScore(0); updateCombo(0);
            timerEl.textContent = timeLeft; levelIndicatorEl.textContent = levelIndex + 1;
            mainIdeasBankEl.innerHTML = ''; detailsBankEl.innerHTML = ''; branchesContainerEl.innerHTML = '';
            mainTopicEl.innerHTML = levelData.mainTopic;

            let subtopicCards = []; let detailCards = []; totalCards = 0; maxScorePossible = 0;

            levelData.subtopics.forEach(subtopic => {
                subtopicCards.push(createCard(subtopic.id, subtopic.text, 'subtopic'));
                totalCards++; maxScorePossible += 10;
                subtopic.details.forEach((detail, index) => {
                    const detailId = `${subtopic.id}-detail-${index}`;
                    detailCards.push(createCard(detailId, detail, 'detail', subtopic.id));
                    totalCards++; maxScorePossible += 10;
                });
            });
            maxScorePossible += 120; // Max time bonus

            shuffle(subtopicCards).forEach(card => mainIdeasBankEl.appendChild(card));
            shuffle(detailCards).forEach(card => detailsBankEl.appendChild(card));

            const numSubtopics = levelData.subtopics.length; const angleStep = 360 / numSubtopics;
            const radiusX = mindMapEl.offsetWidth * 0.35; const radiusY = mindMapEl.offsetHeight * 0.3;
            
            levelData.subtopics.forEach((subtopic, i) => {
                const angleRad = (angleStep * i - 90) * (Math.PI / 180);
                const x = radiusX * Math.cos(angleRad); const y = radiusY * Math.sin(angleRad);
                const container = document.createElement('div');
                container.className = 'absolute'; container.style.left = `calc(50% + ${x}px)`; container.style.top = `calc(50% + ${y}px)`; container.style.transform = 'translate(-50%, -50%)';
                const subtopicDropWrapper = createDropZone(subtopic.id, 'subtopic');
                const detailDropWrapper = createDropZone(`details-for-${subtopic.id}`, 'detail', subtopic.id);
                detailDropWrapper.classList.add('hidden', 'mt-2');
                container.appendChild(subtopicDropWrapper); container.appendChild(detailDropWrapper); branchesContainerEl.appendChild(container);
                const line = document.createElement('div'); const angleDeg = Math.atan2(y, x) * (180 / Math.PI); const length = Math.sqrt(x*x + y*y) - mainTopicEl.offsetWidth / 2.5;
                line.className = 'branch-line'; line.style.width = `${length}px`; line.style.height = '4px';
                line.style.left = `calc(50% + ${mainTopicEl.offsetWidth / 2.5 * Math.cos(angleRad)}px)`;
                line.style.top = `calc(50% + ${mainTopicEl.offsetWidth / 2.5 * Math.sin(angleRad)}px)`;
                line.style.transform = `rotate(${angleDeg}deg)`;
                branchesContainerEl.appendChild(line);
            });
            
            startTimer();
        }

        function onDragStart(e) { e.dataTransfer.setData('text/plain', e.target.id); }
        function onDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function onDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

        function onDrop(e) {
            e.preventDefault(); e.currentTarget.classList.remove('drag-over');
            const cardId = e.dataTransfer.getData('text/plain'); const card = document.getElementById(cardId); const dropZone = e.currentTarget;

            if (validatePlacement(card, dropZone)) {
                playSound('correct');
                const isSubtopic = card.dataset.type === 'subtopic'; card.draggable = false;
                if (isSubtopic) {
                    dropZone.appendChild(card); card.classList.add('placed-subtopic');
                    const detailZone = document.getElementById(`drop-details-for-${card.id}`).parentElement;
                    if (detailZone) detailZone.classList.remove('hidden');
                } else { dropZone.appendChild(card); card.classList.add('placed-card'); }
                card.classList.remove('idea-card');
                updateScore(10); updateCombo(comboCounter + 1);
                placedCards++; if (placedCards === totalCards) endGame(true);
            } else {
                playSound('wrong');
                card.classList.add('shake'); updateCombo(0);
                setTimeout(() => card.classList.remove('shake'), 500);
            }
        }

        function validatePlacement(card, dropZone) {
            const cardType = card.dataset.type; const dropZoneType = dropZone.dataset.type;
            if (cardType === 'subtopic' && dropZoneType === 'subtopic') return card.id === dropZone.dataset.targetId;
            if (cardType === 'detail' && dropZoneType === 'detail') return card.dataset.parentId === dropZone.dataset.parentId;
            return false;
        }

        function updateScore(points) { score += points; scoreEl.textContent = score; }
        
        function updateCombo(value) {
            comboCounter = value;
            comboCounterEl.textContent = comboCounter;
            if (comboCounter > 2 && comboCounter % 3 === 0) {
                const bonus = comboCounter * 5;
                updateScore(bonus);
                comboBonusTextEl.textContent = `+${bonus}`;
                comboBonusTextEl.classList.add('combo-text');
                setTimeout(() => comboBonusTextEl.classList.remove('combo-text'), 500);
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => { timeLeft--; timerEl.textContent = timeLeft; if (timeLeft <= 0) endGame(false); }, 1000);
        }

        function endGame(isWin) {
            clearInterval(timerInterval);
            const ui = translations[selectedLanguage].ui;
            if (isWin) {
                const bonus = timeLeft; updateScore(bonus);
                modalTitleEl.textContent = ui.levelComplete;
                if (currentLevel < translations[selectedLanguage].levels.length - 1) nextLevelBtn.textContent = ui.nextLevel;
                else { modalTitleEl.textContent = ui.gameFinished; nextLevelBtn.textContent = ui.playAgain; }
            } else { modalTitleEl.textContent = ui.timesUp; nextLevelBtn.textContent = ui.tryAgain; }
            finalScoreEl.textContent = score;
            
            // Star Rating Logic
            const scorePercentage = (score / maxScorePossible) * 100;
            const stars = starRatingEl.children;
            stars[0].classList.toggle('filled', scorePercentage > 20);
            stars[1].classList.toggle('filled', scorePercentage > 50);
            stars[2].classList.toggle('filled', scorePercentage > 85);

            modalEl.classList.remove('hidden');
            setTimeout(() => { modalEl.querySelector('div').classList.remove('scale-95', 'opacity-0'); }, 10);
        }
        
        function handleNextAction() {
            modalEl.classList.add('hidden'); modalEl.querySelector('div').classList.add('scale-95', 'opacity-0');
            const ui = translations[selectedLanguage].ui;
            if (nextLevelBtn.textContent === ui.nextLevel) currentLevel++;
            else if (nextLevelBtn.textContent === ui.playAgain) currentLevel = 0;
            setupLevel(currentLevel);
        }

        nextLevelBtn.addEventListener('click', handleNextAction);

        window.onresize = () => {
             if (!gameContainerEl.classList.contains('hidden')) { setTimeout(() => setupLevel(currentLevel), 100); }
        };
    </script>
</body>
</html>

